@page "/"
@using ChessTourBuilderApp.Data.HelpClasses
@using Newtonsoft.Json
@layout MainLayout
@inject NavigationManager NavigationManager

<body class="main-conteneer">
    <section class="left-conteneer left-conteneer-color input-main first">
        <div class="icon"></div>
        <h1 class="text-color-left top-row-text text  big-text" href="">CTB</h1>
        <h2 class="text text-color-left" href="">Chess Tour Bilder</h2>
    </section>
    <section class="left-conteneer input-main second">
        <h1 class="top-row-text text text-color-right" href="">Авторизация</h1>
        <input @bind-value="organizer.Login" placeholder="Логин" type="text">
        <input @bind-value="organizer.Password" placeholder="Пароль" type="password">
        <div style="display:flex;">
            <input @bind-value="IsPlayer" type="checkbox" />
            <h4>Войти как игрок</h4>
        </div>
        <p>@q</p>
        @if (style)
        {
            <h6 class="text alert">Неправильный логин или пароль</h6>
        }
        <button disabled="@doit" @onclick="async ()=> await OnAvtorizate()">Войти</button>
        <button class="text text-color-right border-none" @onclick="@(()=>OnClickNavigate("/registration"))">Регистрация</button>
    </section>
</body>

@code
{
    private Data.Model.Organizer organizer = new();
    private bool style = false, IsPlayer = false, doit = false;
    string q;

    void OnClickNavigate(string str) => NavigationManager.NavigateTo(str);

    async Task OnAvtorizate()
    {
        doit = true;
        if (IsPlayer)
        {
            q = await Data.Api.ApiControler.Post("Account/autorizatePlayer", new { Login = organizer.Login, Password = organizer.Password });
        }
        else q = await Data.Api.ApiControler.Post("Account/autorizate", new { Login = organizer.Login, Password = organizer.Password });

        if (q == "Nice")
        {
            if (IsPlayer)
                StaticResouses.mainControler.PlayerControler.nowPlayer = JsonConvert.DeserializeObject<Data.Model.Player>(await Data.Api.ApiControler.Get("Account/getInfoPlayer"));
            else StaticResouses.mainControler.OrganizerControler.nowOrganizer = JsonConvert.DeserializeObject<Data.Model.Organizer>(await Data.Api.ApiControler.Get("Account/getInfo"));

            Data.HelpClasses.StaticResouses.IsPlayer = IsPlayer;
            OnClickNavigate("/eventList");
        }
        else style = true;
        doit = false;
        StateHasChanged();
    }
}